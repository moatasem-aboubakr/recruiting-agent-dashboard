<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recruiting Agent Dashboard</title>
    
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/percent.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/radar.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/geodata/egyptLow.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Dark.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#8b5cf6',
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            text: '#f1f5f9',
                            border: '#334155'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Sidebar Transition */
        #sidebar { transition: margin-left 0.3s ease-in-out; }
        #sidebar.collapsed { margin-left: -20rem; }
        
        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 2px;
        }
        .dark input[type=range]::-webkit-slider-runnable-track {
            background: #475569;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-dark-bg dark:text-dark-text transition-colors duration-300 antialiased overflow-hidden h-screen flex flex-col">

    <header class="h-16 bg-white dark:bg-dark-card border-b border-gray-200 dark:border-dark-border flex items-center px-6 transition-colors duration-300 z-30 shrink-0 shadow-sm relative">
        <div class="flex items-center gap-4 w-1/4">
             <button id="sidebarToggle" onclick="toggleSidebar()" class="p-2 rounded-lg text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700 transition-colors">
                <i class="ph ph-list text-xl"></i>
            </button>
            <div class="flex flex-col">
                <h1 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                    DSAI-203
                </h1>
            </div>
        </div>

        <div class="flex-1 flex justify-center">
            <h2 class="text-lg font-bold text-gray-800 dark:text-white tracking-wide uppercase hidden md:block">
                Recruiting Agent Dashboard
            </h2>
        </div>

        <div class="flex items-center justify-end gap-3 w-1/4">
             <button onclick="openSheetModal()" class="hidden sm:flex items-center gap-2 px-5 py-2.5 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors shadow-sm">
                <i class="ph-bold ph-google-logo text-lg"></i>
                Connect Sheet
            </button>
            
            <button id="darkModeToggle" onclick="toggleDarkMode()" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-yellow-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                <i id="darkModeIcon" class="ph-fill ph-moon text-xl"></i>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <aside id="sidebar" class="w-80 bg-white dark:bg-dark-card border-r border-gray-200 dark:border-dark-border flex flex-col z-20 transition-all duration-300 overflow-y-auto absolute md:relative h-full">
            <div class="p-5 space-y-6">
                
                <div class="flex items-center justify-between">
                    <h3 class="font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                        <i class="ph-fill ph-faders"></i> Filters Panel
                    </h3>
                    <button onclick="resetFilters()" class="text-xs text-blue-600 dark:text-blue-400 hover:underline font-medium">Reset</button>
                </div>

                <div class="space-y-2">
                     <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Specialization</label>
                     <select id="specFilter" onchange="updateDashboard()" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option value="All">All Specializations</option>
                        </select>
                </div>

                 <div class="space-y-2">
                     <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">City</label>
                     <select id="cityFilter" onchange="updateDashboard()" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option value="All">All Cities</option>
                        </select>
                </div>

                <hr class="border-gray-100 dark:border-gray-700">

                 <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Gender</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="Male" class="gender-filter form-checkbox rounded text-blue-600 dark:bg-gray-800" checked onchange="updateDashboard()">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Male</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="Female" class="gender-filter form-checkbox rounded text-pink-500 dark:bg-gray-800" checked onchange="updateDashboard()">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Female</span>
                        </label>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Education Level</label>
                    <div class="space-y-1.5" id="eduFilterContainer">
                        </div>
                </div>

                <hr class="border-gray-100 dark:border-gray-700">

                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Employment Status</label>
                    <div class="space-y-1.5" id="statusFilterContainer">
                         </div>
                </div>

                <hr class="border-gray-100 dark:border-gray-700">

                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Experience</label>
                        <span class="text-xs font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 px-2 py-0.5 rounded" id="expValueDisplay">All</span>
                    </div>
                    <div class="px-1">
                        <input type="range" id="expRange" min="0" max="25" value="25" step="1" oninput="updateDashboard()" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                    </div>
                </div>

                <div class="space-y-4">
                     <div class="flex justify-between items-center">
                        <label class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Max Salary</label>
                        <span class="text-xs font-medium text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/20 px-2 py-0.5 rounded" id="salaryValueDisplay">All</span>
                    </div>
                    <div class="px-1">
                        <input type="range" id="salaryRange" min="5000" max="100000" value="100000" step="5000" oninput="updateDashboard()" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                    </div>
                </div>

            </div>
        </aside>

        <main id="main-content" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth bg-gray-50 dark:bg-dark-bg transition-all duration-300">
            <div class="max-w-[1600px] mx-auto space-y-6">

                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Overview</h2>
                        <p class="text-sm text-gray-500 dark:text-gray-400" id="data-source-label">Source: No Data Loaded</p>
                    </div>
                    <div class="bg-white dark:bg-dark-card px-4 py-1.5 rounded-full border border-gray-200 dark:border-dark-border shadow-sm text-sm font-medium text-gray-600 dark:text-gray-300">
                        <span id="recordCount" class="text-blue-600 dark:text-blue-400 font-bold">0</span> Candidates Match
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-white dark:bg-dark-card p-5 rounded-xl shadow-sm border border-gray-200 dark:border-dark-border">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Candidates</p>
                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white mt-1" id="kpi-total">0</h3>
                    </div>
                    <div class="bg-white dark:bg-dark-card p-5 rounded-xl shadow-sm border border-gray-200 dark:border-dark-border">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Avg. Expected Salary</p>
                        <h3 class="text-2xl font-bold text-purple-600 dark:text-purple-400 mt-1" id="kpi-salary">0 EGP</h3>
                    </div>
                    <div class="bg-white dark:bg-dark-card p-5 rounded-xl shadow-sm border border-gray-200 dark:border-dark-border">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Avg. Years of Experience</p>
                        <h3 class="text-2xl font-bold text-emerald-600 dark:text-emerald-400 mt-1" id="kpi-experience">0</h3>
                    </div>
                    <div class="bg-white dark:bg-dark-card p-5 rounded-xl shadow-sm border border-gray-200 dark:border-dark-border">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Employed Candidates</p>
                        <h3 class="text-2xl font-bold text-orange-600 dark:text-orange-400 mt-1" id="kpi-employed">0</h3>
                    </div>
                </div>

                <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-5">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Employment Status Distribution</h3>
                    <div id="chartFunnel" class="w-full h-[300px]"></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-5">
                        <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Experience vs. Salary Distribution by Role</h3>
                        <div id="chartSpec" class="w-full h-[300px]"></div>
                    </div>

                    <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-5">
                        <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Geographic Distribution</h3>
                        <div id="chartCity" class="w-full h-[300px]"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-5">
                        <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Compensation Analysis: Salary Range and Average by Role</h3>
                        <div id="chartSalary" class="w-full h-[300px]"></div>
                    </div>
                    
                    <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-5">
                        <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Correlation: Certificates vs. Salary</h3>
                        <div id="chartCertLine" class="w-full h-[300px]"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-5">
                        <h3 class="text-sm font-bold text-gray-800 dark:text-white mb-2">Gender Distribution</h3>
                        <div id="chartGender" class="w-full h-[200px]"></div>
                    </div>
                    <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-5">
                        <h3 class="text-sm font-bold text-gray-800 dark:text-white mb-2">Education Level</h3>
                        <div id="chartEdu" class="w-full h-[200px]"></div>
                    </div>
                    <div class="bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border p-5">
                        <h3 class="text-sm font-bold text-gray-800 dark:text-white mb-2">Employment Status</h3>
                        <div id="chartStatus" class="w-full h-[200px]"></div>
                    </div>
                </div>

                <footer class="text-center text-sm text-gray-500 dark:text-gray-400 pb-6">
                    &copy; 2025 DSAI-203 Project. Built with AmCharts 5.
                </footer>
            </div>
        </main>
    </div>

    <div id="sheetModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-dark-card p-6 rounded-xl shadow-2xl w-full max-w-md mx-4 border border-gray-200 dark:border-gray-700">
            <h3 class="text-xl font-bold mb-2 text-gray-900 dark:text-white">Connect Google Sheet</h3>
            <p class="text-sm text-gray-500 mb-4">Paste the link to your Google Sheet CSV export. <br><span class="text-xs opacity-75">File > Share > Publish to Web > CSV</span></p>
            
            <input type="text" id="sheetUrl" placeholder="https://docs.google.com/.../pub?output=csv" class="w-full p-2.5 mb-4 border rounded-lg bg-gray-50 dark:bg-gray-800 dark:border-gray-600 text-sm focus:ring-2 focus:ring-blue-500 outline-none dark:text-white">
            
            <p class="text-xs text-gray-400 mb-2">Or paste raw CSV data directly:</p>
            <textarea id="csvPaste" rows="3" class="w-full p-2.5 mb-4 border rounded-lg bg-gray-50 dark:bg-gray-800 dark:border-gray-600 text-xs font-mono outline-none dark:text-white" placeholder="Candidate_ID,Specialization,Years_of_Experience..."></textarea>

            <div class="flex justify-end gap-3">
                <button onclick="closeSheetModal()" class="px-4 py-2 text-gray-600 dark:text-gray-300 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Cancel</button>
                <button id="loadBtn" onclick="loadSheetData()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg flex items-center gap-2">
                    <span>Load Data</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Global State ---
        let rawData = [];
        let rootRefs = {}; // Store chart roots
        
        // --- 1. Google Sheet / CSV Logic ---
        function openSheetModal() {
            document.getElementById('sheetModal').classList.remove('hidden');
        }
        function closeSheetModal() {
            document.getElementById('sheetModal').classList.add('hidden');
        }

        async function loadSheetData() {
            let url = document.getElementById('sheetUrl').value.trim();
            const rawCsv = document.getElementById('csvPaste').value.trim();
            const btn = document.getElementById('loadBtn');
            const sourceLabel = document.getElementById('data-source-label');
            
            if (!url && !rawCsv) {
                alert("Please provide either a Google Sheet URL or paste CSV data.");
                return;
            }
            
            // Set Loading State
            btn.innerHTML = `<i class="ph ph-spinner animate-spin"></i> Loading...`;
            btn.disabled = true;
            sourceLabel.innerText = "Loading data...";

            const resetBtn = () => {
                btn.innerHTML = `Load Data`;
                btn.disabled = false;
            };

            // Helper to clear data on failure
            const clearDataOnFail = () => {
                rawData = [];
                updateDashboard();
                resetBtn();
                closeSheetModal();
            };
            
            // CASE A: Pasted CSV
            if (rawCsv) {
                try {
                    parseCSV(rawCsv);
                    sourceLabel.innerText = `Source: Pasted CSV Data (${rawData.length} records)`;
                    resetBtn();
                    closeSheetModal();
                } catch (error) {
                    alert(`Error parsing CSV data: ${error.message}`);
                    sourceLabel.innerText = "Source: Error parsing CSV";
                    clearDataOnFail(); 
                }
                return;
            }

            // CASE B: URL Fetch
            if (url) {
                // Add Cache Buster
                if (url.includes('?')) {
                    url += `&t=${Date.now()}`;
                } else {
                    url += `?t=${Date.now()}`;
                }

                try {
                    // ATTEMPT 1: Direct Fetch
                    console.log("Attempting direct fetch...");
                    let response = await fetch(url, { method: 'GET', redirect: "follow" });
                    
                    if (!response.ok) {
                        throw new Error(`Direct fetch failed: ${response.status}`);
                    }
                    
                    let text = await response.text();

                    // Check if we got HTML instead of CSV (Google auth screen)
                    if (text.trim().toLowerCase().startsWith("<!doctype html") || text.includes("<html")) {
                        throw new Error("Received HTML instead of CSV. Link might not be published.");
                    }

                    parseCSV(text);
                    sourceLabel.innerText = `Source: Live Google Sheet (${rawData.length} records)`;
                    resetBtn();
                    closeSheetModal();

                } catch (directError) {
                    console.warn("Direct fetch failed, trying proxy...", directError);
                    
                    // ATTEMPT 2: Proxy Fallback (Fix for CORS/Localhost issues)
                    try {
                        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                        let proxyResponse = await fetch(proxyUrl);
                        
                        if (!proxyResponse.ok) throw new Error(`Proxy fetch failed: ${proxyResponse.status}`);
                        
                        let proxyText = await proxyResponse.text();
                        
                        if (!proxyText || proxyText.trim().length === 0) throw new Error("Empty response from Proxy");
                        
                        parseCSV(proxyText);
                        sourceLabel.innerText = `Source: Google Sheet (via Proxy) - ${rawData.length} records`;
                        resetBtn();
                        closeSheetModal();
                        
                    } catch (proxyError) {
                        alert(`Failed to load Google Sheet.\n\nReason: ${directError.message}\nProxy Reason: ${proxyError.message}\n\nPlease ensure:\n1. File > Share > Publish to web > CSV is selected.\n2. The link is publicly accessible.`);
                        console.error("All fetch attempts failed:", proxyError);
                        sourceLabel.innerText = "Source: Error loading data";
                        clearDataOnFail();
                    }
                }
            }
        }

        function parseCSV(csvText) {
            // 1. Remove Byte Order Mark (BOM)
            if (csvText.charCodeAt(0) === 0xFEFF) {
                csvText = csvText.slice(1);
            }

            const lines = csvText.split(/\r?\n/).filter(l => l.trim());
            if (lines.length === 0) throw new Error("CSV appears to be empty");
            
            // Helper to parse a CSV line handling quotes
            const parseLine = (text) => {
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    if (char === '"') {
                        // Handle escaped quotes ("")
                        if (inQuotes && text[i+1] === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim()); // Keep raw for now
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                return values;
            };

            // Parse Headers
            let headers = parseLine(lines[0]);
            
            // Normalize headers
            headers = headers.map(h => h.replace(/^["']|["']$/g, '').replace(/\s+/g, '_'));
            
            console.log('Parsed headers:', headers);

            // Parse Data
            const newData = [];
            for (let lineIdx = 1; lineIdx < lines.length; lineIdx++) {
                const line = lines[lineIdx];
                if (!line.trim()) continue;
                
                const values = parseLine(line);
                
                // Relaxed length check (allow trailing empty cols)
                if (values.length < 2) continue; 
                
                let obj = {};
                headers.forEach((h, i) => {
                    let val = values[i] || "";
                    
                    // Clean quotes around value
                    val = val.replace(/^["']|["']$/g, '');

                    // Numeric Conversion
                    if (["Expected_Salary", "Years_of_Experience", "Age", "Number_of_Certificates"].includes(h)) {
                        let cleanVal = val.replace(/,/g, '').replace(/[^\d.-]/g, '');
                        val = parseFloat(cleanVal) || 0;
                    }
                    obj[h] = val;
                });
                newData.push(obj);
            }

            if (newData.length > 0) {
                rawData = newData;
                
                // Dispose old charts
                Object.values(rootRefs).forEach(root => {
                    try { root.dispose(); } catch (e) { console.warn(e); }
                });
                rootRefs = {};
                
                // Reinitialize
                populateFilters();
                initCharts();
                updateDashboard();
                
                // alert(`Successfully loaded ${newData.length} records!`);
            } else {
                throw new Error("No valid data rows found in CSV");
            }
        }
        
        // --- 2. Filter Population ---
        function populateFilters() {
            if (rawData.length === 0) return;

            const getUnique = (key) => [...new Set(rawData.map(d => d[key]))].sort().filter(x => x);

            // Specialization
            const specs = getUnique("Specialization");
            const specSelect = document.getElementById('specFilter');
            specSelect.innerHTML = '<option value="All">All Specializations</option>';
            specs.forEach(s => specSelect.innerHTML += `<option value="${s}">${s}</option>`);

            // City
            const cities = getUnique("City");
            const citySelect = document.getElementById('cityFilter');
            citySelect.innerHTML = '<option value="All">All Cities</option>';
            cities.forEach(c => citySelect.innerHTML += `<option value="${c}">${c}</option>`);

            // Education (Checkboxes)
            const edus = getUnique("Education_Level");
            const eduContainer = document.getElementById('eduFilterContainer');
            eduContainer.innerHTML = '';
            edus.forEach(e => {
                eduContainer.innerHTML += `
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" value="${e}" class="edu-filter form-checkbox rounded text-blue-600 dark:bg-gray-800" checked onchange="updateDashboard()">
                        <span class="text-sm text-gray-700 dark:text-gray-300">${e}</span>
                    </label>`;
            });

            // Status (Checkboxes)
            const stats = getUnique("Employment_Status");
            const statContainer = document.getElementById('statusFilterContainer');
            statContainer.innerHTML = '';
            stats.forEach(s => {
                statContainer.innerHTML += `
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" value="${s}" class="status-filter form-checkbox rounded text-blue-600 dark:bg-gray-800" checked onchange="updateDashboard()">
                        <span class="text-sm text-gray-700 dark:text-gray-300">${s}</span>
                    </label>`;
            });
        }

        // --- 3. Sidebar Toggle ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebarToggle');
            sidebar.classList.toggle('collapsed');
            
            // Just CSS transform, charts resize automatically usually, but might need invalidation
            setTimeout(() => {
                Object.values(rootRefs).forEach(r => r.resize());
            }, 350);
        }

        // --- 4. Update Logic ---
        function updateDashboard() {
            if (rawData.length === 0) return;

            // Gather Filter Values
            const spec = document.getElementById('specFilter').value;
            const city = document.getElementById('cityFilter').value;
            
            const genders = Array.from(document.querySelectorAll('.gender-filter:checked')).map(cb => cb.value);
            const edus = Array.from(document.querySelectorAll('.edu-filter:checked')).map(cb => cb.value);
            const stats = Array.from(document.querySelectorAll('.status-filter:checked')).map(cb => cb.value);
            
            const maxExp = parseInt(document.getElementById('expRange').value);
            const maxSalary = parseInt(document.getElementById('salaryRange').value);

            // Update Displays
            document.getElementById('expValueDisplay').innerText = maxExp >= 25 ? "All" : `<= ${maxExp} Yrs`;
            document.getElementById('salaryValueDisplay').innerText = maxSalary >= 100000 ? "All" : `<= ${maxSalary.toLocaleString()}`;

            // Filtering
            const filtered = rawData.filter(d => {
                return (spec === "All" || d.Specialization === spec) &&
                       (city === "All" || d.City === city) &&
                       (genders.includes(d.Gender)) &&
                       (edus.includes(d.Education_Level)) &&
                       (stats.includes(d.Employment_Status)) &&
                       (d.Years_of_Experience <= maxExp) &&
                       (d.Expected_Salary <= maxSalary);
            });

            // Update KPIs
            const total = filtered.length;
            document.getElementById('recordCount').innerText = total;
            
            // 1. Total Candidates
            document.getElementById('kpi-total').innerText = total.toLocaleString();

            // 2. Average Expected Salary (from dataset)
            const avgSalary = total > 0 
                ? Math.round(filtered.reduce((sum, d) => sum + (parseFloat(d.Expected_Salary) || 0), 0) / total)
                : 0;
            document.getElementById('kpi-salary').innerText = avgSalary.toLocaleString() + " EGP";

            // 3. Average Years of Experience (from dataset)
            const avgExperience = total > 0
                ? (filtered.reduce((sum, d) => sum + (parseFloat(d.Years_of_Experience) || 0), 0) / total).toFixed(1)
                : 0;
            document.getElementById('kpi-experience').innerText = avgExperience + " Yrs";

            // 4. Employed Candidates (from dataset)
            const employedCount = filtered.filter(d => d.Employment_Status === "Employed").length;
            document.getElementById('kpi-employed').innerText = employedCount.toLocaleString();

            // Update Charts
            updateCharts(filtered, total);
        }

        function resetFilters() {
            document.getElementById('specFilter').value = "All";
            document.getElementById('cityFilter').value = "All";
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
            document.getElementById('expRange').value = 25;
            document.getElementById('salaryRange').value = 100000;
            updateDashboard();
        }

        // --- 5. Chart Definitions (AmCharts) ---
        function initCharts() {
            const isDark = document.documentElement.classList.contains('dark');
            const theme = isDark ? am5themes_Dark : am5themes_Animated;

            // Helper to create root and apply theme
            const createRoot = (id) => {
                let root = am5.Root.new(id);
                root.setThemes([am5themes_Animated.new(root)]);
                if (document.documentElement.classList.contains('dark')) {
                    root.setThemes([am5themes_Dark.new(root)]);
                }
                return root;
            };

            // NEW: Funnel Chart
            {
                let root = createRoot("chartFunnel");
                rootRefs.chartFunnel = root;
                let chart = root.container.children.push(am5percent.SlicedChart.new(root, {
                    layout: root.horizontalLayout
                }));
                let series = chart.series.push(am5percent.FunnelSeries.new(root, {
                    alignLabels: false,
                    orientation: "horizontal",
                    valueField: "value",
                    categoryField: "stage"
                }));
                series.labels.template.set("text", "{category}: [bold]{value}[/]");
                root.series = series;
            }

            // 1. Spec Scatter Chart
            {
                let root = createRoot("chartSpec");
                rootRefs.chartSpec = root;
                let chart = root.container.children.push(am5xy.XYChart.new(root, { 
                    panX: true, 
                    panY: true, 
                    wheelX: "panX", 
                    wheelY: "zoomX",
                    pinchZoomX: true 
                }));
                
                let xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root, { 
                    renderer: am5xy.AxisRendererX.new(root, {}), 
                    tooltip: am5.Tooltip.new(root, {}),
                    min: 0,
                    maxPrecision: 0
                }));
                xAxis.children.push(am5.Label.new(root, { 
                    text: "Years of Experience", 
                    x: am5.p50, 
                    centerX: am5.p50 
                }));
                
                let yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, { 
                    renderer: am5xy.AxisRendererY.new(root, {}), 
                    tooltip: am5.Tooltip.new(root, {}) 
                }));
                yAxis.children.unshift(am5.Label.new(root, { 
                    text: "Expected Salary (EGP)", 
                    rotation: -90, 
                    y: am5.p50, 
                    centerX: am5.p50 
                }));
                
                let series = chart.series.push(am5xy.LineSeries.new(root, { 
                    xAxis: xAxis, 
                    yAxis: yAxis, 
                    valueYField: "salary", 
                    valueXField: "experience",
                    stroke: am5.color(0x3b82f6),
                    fill: am5.color(0x3b82f6)
                }));
                
                series.strokes.template.set("strokeWidth", 0);
                
                series.bullets.push(function() { 
                    let circle = am5.Circle.new(root, { 
                        radius: 5, 
                        fill: series.get("fill"),
                        fillOpacity: 0.7,
                        stroke: root.interfaceColors.get("background"), 
                        strokeWidth: 2,
                        tooltipText: "[bold]{specialization}[/]\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nðŸ‘¤ ID: {id}\nðŸ“ City: {city}\nðŸ’¼ Status: {status}\nðŸŽ“ Education: {education}\nðŸ‘¥ Gender: {gender}\nðŸ“… Age: {age}\nðŸ“œ Certificates: {certificates}\nðŸ’° Salary: {salary} EGP\nâ±ï¸ Experience: {experience} Yrs"
                    });
                    
                    circle.adapters.add("fill", function(fill, target) {
                        let dataItem = target.dataItem;
                        if (dataItem) {
                            let specialization = dataItem.dataContext.specialization;
                            let colors = {
                                "Software Engineer": 0x3b82f6,
                                "Data Scientist": 0x8b5cf6,
                                "Product Manager": 0x10b981,
                                "Sales Representative": 0xf59e0b,
                                "HR Specialist": 0xec4899,
                                "Accountant": 0x06b6d4,
                                "Marketing Manager": 0xf97316,
                                "Civil Engineer": 0x6366f1,
                                "Graphic Designer": 0x14b8a6
                            };
                            return am5.color(colors[specialization] || 0x64748b);
                        }
                        return fill;
                    });
                    
                    return am5.Bullet.new(root, { sprite: circle }); 
                });
                
                root.series = series;
                root.xAxis = xAxis;
                root.yAxis = yAxis;
            }

            // 2. City Map Chart
            {
                let root = createRoot("chartCity");
                rootRefs.chartCity = root;
                
                let chart = root.container.children.push(am5map.MapChart.new(root, {
                    panX: "rotateX",
                    panY: "translateY",
                    projection: am5map.geoMercator(),
                    homeGeoPoint: { latitude: 26.8206, longitude: 30.8025 }
                }));

                let polygonSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {
                    geoJSON: am5geodata_egyptLow,
                    valueField: "value",
                    calculateAggregates: true
                }));

                polygonSeries.mapPolygons.template.setAll({
                    tooltipText: "{name}: {value} Candidates"
                });

                polygonSeries.set("heatRules", [{
                    target: polygonSeries.mapPolygons.template,
                    dataField: "value",
                    min: am5.color(0xe0f2fe), // Light Blue
                    max: am5.color(0x0284c7), // Dark Blue (Brand color)
                    key: "fill"
                }]);

                root.series = polygonSeries;
            }

            // 3. Salary Range Chart (Min/Max/Avg with Insights)
            {
                let root = createRoot("chartSalary");
                rootRefs.chartSalary = root;
                let chart = root.container.children.push(am5xy.XYChart.new(root, { 
                    panX: true, 
                    panY: false, 
                    wheelX: "panX", 
                    wheelY: "zoomX"
                }));
                
                let xRenderer = am5xy.AxisRendererX.new(root, { minGridDistance: 30 });
                xRenderer.labels.template.setAll({ rotation: -45, centerY: am5.p50, centerX: am5.p100 });
                let xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, { categoryField: "category", renderer: xRenderer }));
                let yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, { 
                    renderer: am5xy.AxisRendererY.new(root, {}),
                    title: am5.Label.new(root, { text: "Salary (EGP)", rotation: -90, y: am5.p50 })
                }));
                
                // Average salary as main columns
                let avgSeries = chart.series.push(am5xy.ColumnSeries.new(root, {
                    valueYField: "avg",
                    categoryXField: "category",
                    xAxis: xAxis,
                    yAxis: yAxis
                }));
                
                avgSeries.columns.template.setAll({
                    strokeWidth: 2,
                    fillOpacity: 0.75,
                    cornerRadiusTL: 5,
                    cornerRadiusTR: 5
                });
                avgSeries.columns.template.adapters.add("fill", (fill, target) => {
                    return am5.color(0x3b82f6);
                });
                avgSeries.columns.template.adapters.add("stroke", (stroke, target) => {
                    return am5.color(0x2563eb);
                });
                
                // Min markers (green)
                let minSeries = chart.series.push(am5xy.LineSeries.new(root, {
                    valueYField: "min",
                    categoryXField: "category",
                    xAxis: xAxis,
                    yAxis: yAxis,
                    stroke: am5.color(0x10b981),
                    strokeWidth: 0
                }));
                
                minSeries.bullets.push(function() {
                    return am5.Bullet.new(root, {
                        sprite: am5.Circle.new(root, {
                            radius: 5,
                            fill: am5.color(0x10b981),
                            stroke: root.interfaceColors.get("background"),
                            strokeWidth: 2
                        })
                    });
                });
                
                // Max markers (orange)
                let maxSeries = chart.series.push(am5xy.LineSeries.new(root, {
                    valueYField: "max",
                    categoryXField: "category",
                    xAxis: xAxis,
                    yAxis: yAxis,
                    stroke: am5.color(0xf59e0b),
                    strokeWidth: 0
                }));
                
                maxSeries.bullets.push(function() {
                    return am5.Bullet.new(root, {
                        sprite: am5.Circle.new(root, {
                            radius: 5,
                            fill: am5.color(0xf59e0b),
                            stroke: root.interfaceColors.get("background"),
                            strokeWidth: 2
                        })
                    });
                });
                
                // Enhanced tooltip with all insights
                avgSeries.set("tooltip", am5.Tooltip.new(root, {
                    labelText: "[bold]{category}[/]\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ“Š Average: {avg} EGP\nâ¬‡ï¸ Min: {min} EGP\nâ¬†ï¸ Max: {max} EGP\nðŸ“ Range: {range} EGP\nðŸ‘¥ Count: {count} candidates"
                }));
                
                minSeries.set("tooltip", am5.Tooltip.new(root, {
                    labelText: "[bold]{category}[/]\nMinimum Salary: {valueY} EGP"
                }));
                
                maxSeries.set("tooltip", am5.Tooltip.new(root, {
                    labelText: "[bold]{category}[/]\nMaximum Salary: {valueY} EGP"
                }));
                
                root.series = [avgSeries, minSeries, maxSeries];
                root.xAxis = xAxis;
            }

            // 4. Line Chart (Certificates vs Avg Salary)
            {
                let root = createRoot("chartCertLine");
                rootRefs.chartCertLine = root;
                let chart = root.container.children.push(am5xy.XYChart.new(root, { panX: true, panY: true, wheelX: "panX", wheelY: "zoomX", pinchZoomX: true }));
                
                let xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root, { 
                    renderer: am5xy.AxisRendererX.new(root, {}), 
                    tooltip: am5.Tooltip.new(root, {}),
                    min: 0,
                    maxPrecision: 0
                }));
                xAxis.children.push(am5.Label.new(root, { text: "Number of Certificates", x: am5.p50, centerX: am5.p50 }));
                
                let yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, { 
                    renderer: am5xy.AxisRendererY.new(root, {}), 
                    tooltip: am5.Tooltip.new(root, {}) 
                }));
                yAxis.children.unshift(am5.Label.new(root, { text: "Avg. Salary (EGP)", rotation: -90, y: am5.p50, centerX: am5.p50 }));
                
                let series = chart.series.push(am5xy.LineSeries.new(root, { 
                    xAxis: xAxis, 
                    yAxis: yAxis, 
                    valueYField: "avgSalary", 
                    valueXField: "certificates", 
                    tooltip: am5.Tooltip.new(root, { labelText: "{valueX} certs: {valueY} EGP" }) 
                }));
                
                series.strokes.template.setAll({ strokeWidth: 3, stroke: am5.color(0xec4899) });
                series.fills.template.setAll({ visible: true, fillOpacity: 0.2, fill: am5.color(0xec4899) });
                
                series.bullets.push(function() { 
                    return am5.Bullet.new(root, { 
                        sprite: am5.Circle.new(root, { radius: 4, fill: series.get("fill"), stroke: root.interfaceColors.get("background"), strokeWidth: 2 }) 
                    }); 
                });
                
                root.series = series;
            }

            // 5. Demographics (Donut Charts)
            ["chartGender", "chartEdu", "chartStatus"].forEach((id, idx) => {
                let root = createRoot(id);
                rootRefs[id] = root;
                let chart = root.container.children.push(am5percent.PieChart.new(root, { 
                    layout: root.horizontalLayout, 
                    innerRadius: am5.percent(60) 
                }));
                let series = chart.series.push(am5percent.PieSeries.new(root, { valueField: "count", categoryField: "category" }));
                series.labels.template.set("forceHidden", true);
                series.ticks.template.set("visible", false);
                root.series = series;
            });
        }

        function updateCharts(data, total) {
            // Aggregation Helpers
            const getCounts = (key) => {
                const map = {};
                data.forEach(d => map[d[key]] = (map[d[key]] || 0) + 1);
                return Object.keys(map).map(k => ({ category: k, count: map[k] })).sort((a,b) => b.count - a.count);
            };
            
            // Update Funnel
            const statusCounts = getCounts("Employment_Status");
            const funnelData = statusCounts.map(item => ({
                stage: item.category,
                value: item.count
            }));
            funnelData.sort((a, b) => b.value - a.value);
            rootRefs.chartFunnel.series.data.setAll(funnelData);

            // 1. Spec Scatter Data
            const scatterData = data.map(d => ({
                id: d.Candidate_ID,
                specialization: d.Specialization,
                experience: parseFloat(d.Years_of_Experience) || 0,
                salary: parseFloat(d.Expected_Salary) || 0,
                city: d.City,
                status: d.Employment_Status,
                education: d.Education_Level,
                gender: d.Gender,
                age: d.Age || 0,
                certificates: d.Number_of_Certificates || 0
            }));
            rootRefs.chartSpec.series.data.setAll(scatterData);

            // 2. City/Governorate Mapping
            const cityToGovernorateMap = {
                "Cairo": "EG-C", "Alexandria": "EG-ALX", "Giza": "EG-GZ",
                "Mansoura": "EG-DK", "Dakahlia": "EG-DK", "Tanta": "EG-GH", "Gharbia": "EG-GH",
                "Zagazig": "EG-SHR", "Sharqia": "EG-SHR", "Banha": "EG-KB", "Qalyubia": "EG-KB",
                "Kafr El Sheikh": "EG-KFS", "Shibin El Kom": "EG-MNF", "Monufia": "EG-MNF",
                "Damanhur": "EG-BH", "Beheira": "EG-BH", "Damietta": "EG-DT", "Port Said": "EG-PTS",
                "Suez": "EG-SUZ", "Ismailia": "EG-IS", "Beni Suef": "EG-BNS", "Fayoum": "EG-FYM",
                "Minya": "EG-MN", "Asyut": "EG-AST", "Sohag": "EG-SHG", "Qena": "EG-KN",
                "Luxor": "EG-LX", "Aswan": "EG-ASN", "Hurghada": "EG-BA", "Red Sea": "EG-BA",
                "Kharga": "EG-WAD", "New Valley": "EG-WAD", "Marsa Matruh": "EG-MT", "Matrouh": "EG-MT",
                "El Arish": "EG-SIN", "North Sinai": "EG-SIN", "Sharm El Sheikh": "EG-JS", "South Sinai": "EG-JS"
            };

            const normalizeCityName = (cityName) => {
                if (!cityName) return null;
                return cityName.trim();
            };

            const allGovernorates = [
                "EG-C", "EG-ALX", "EG-GZ", "EG-DK", "EG-GH", "EG-SHR", "EG-KB", 
                "EG-KFS", "EG-MNF", "EG-BH", "EG-DT", "EG-PTS", "EG-SUZ", "EG-IS", 
                "EG-BNS", "EG-FYM", "EG-MN", "EG-AST", "EG-SHG", "EG-KN", "EG-LX", 
                "EG-ASN", "EG-BA", "EG-WAD", "EG-MT", "EG-SIN", "EG-JS"
            ];
            
            const cityCounts = {};
            allGovernorates.forEach(id => cityCounts[id] = 0);
            
            data.forEach(d => {
                const cityName = normalizeCityName(d.City);
                if (!cityName) return;
                
                let id = cityToGovernorateMap[cityName];
                if (!id) {
                    const cityLower = cityName.toLowerCase();
                    for (const [key, value] of Object.entries(cityToGovernorateMap)) {
                        if (key.toLowerCase() === cityLower) {
                            id = value;
                            break;
                        }
                    }
                }
                
                if (id && cityCounts.hasOwnProperty(id)) {
                    cityCounts[id] = (cityCounts[id] || 0) + 1;
                }
            });
            
            const mapData = allGovernorates.map(id => ({ id: id, value: cityCounts[id] || 0 }));
            rootRefs.chartCity.series.data.setAll(mapData);


            // 3. Salary (Enhanced)
            const getSalaryStats = (catKey, valKey) => {
                const map = {};
                const minMap = {};
                const maxMap = {};
                const countMap = {};
                
                data.forEach(d => {
                    const cat = d[catKey];
                    const val = parseFloat(d[valKey]) || 0;
                    
                    if (!map[cat]) {
                        map[cat] = 0;
                        minMap[cat] = Infinity;
                        maxMap[cat] = -Infinity;
                        countMap[cat] = 0;
                    }
                    
                    map[cat] += val;
                    countMap[cat]++;
                    if (val < minMap[cat]) minMap[cat] = val;
                    if (val > maxMap[cat]) maxMap[cat] = val;
                });
                
                return Object.keys(map).map(k => {
                    const avg = Math.round(map[k] / countMap[k]);
                    const min = minMap[k] === Infinity ? 0 : Math.round(minMap[k]);
                    const max = maxMap[k] === -Infinity ? 0 : Math.round(maxMap[k]);
                    return {
                        category: k,
                        avg: avg,
                        min: min,
                        max: max,
                        range: max - min,
                        count: countMap[k]
                    };
                }).sort((a, b) => b.avg - a.avg).slice(0, 10);
            };
            
            const salaryData = getSalaryStats("Specialization", "Expected_Salary");
            rootRefs.chartSalary.series[0].data.setAll(salaryData);
            rootRefs.chartSalary.series[1].data.setAll(salaryData);
            rootRefs.chartSalary.xAxis.data.setAll(salaryData);

            // 4. Line Chart: Certificates
            const certMap = {};
            const certCount = {};
            data.forEach(d => {
                const certs = parseFloat(d.Number_of_Certificates) || 0;
                const salary = parseFloat(d.Expected_Salary) || 0;
                certMap[certs] = (certMap[certs] || 0) + salary;
                certCount[certs] = (certCount[certs] || 0) + 1;
            });
            const certData = Object.keys(certMap).map(c => ({
                certificates: parseInt(c),
                avgSalary: Math.round(certMap[c] / certCount[c])
            })).sort((a,b) => a.certificates - b.certificates);
            rootRefs.chartCertLine.series.data.setAll(certData);

            // 5. Pies
            rootRefs.chartGender.series.data.setAll(getCounts("Gender"));
            rootRefs.chartEdu.series.data.setAll(getCounts("Education_Level"));
            rootRefs.chartStatus.series.data.setAll(getCounts("Employment_Status"));
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            if (rawData.length > 0) {
                 // Reload charts to apply theme
                Object.values(rootRefs).forEach(root => root.dispose());
                initCharts();
                updateDashboard();
            }
        }

        // --- Init ---
        // Do not auto-load, wait for user input
        am5.ready(() => {
            // Charts will be initialized on first data load
        });

    </script>
</body>
</html>